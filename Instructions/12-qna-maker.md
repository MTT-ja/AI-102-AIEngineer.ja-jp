---
lab:
  title: 質問応答ソリューションを作成する
  module: Module 6 - Create question answering solutions with Azure AI Language
---

# 質問応答ソリューションを作成する

最も一般的な会話シナリオの 1 つは、よくある質問 (FAQ) のナレッジ ベースを通じてサポートを提供することです。 多くの組織は、FAQ をドキュメントまたは Web ページとして公開しています。これは、質問と回答のペアの小さなセットに適していますが、大きなドキュメントは検索が難しく、時間がかかる場合があります。

**Azure AI Language** には、*質問応答*機能が含まれており、これを使用すると、自然言語で入力してクエリを実行できる、質問と回答のペアで構成されるナレッジ ベースを作成でき、ボットがユーザーから送信された質問への回答を検索するために使用できるリソースとして最も一般的に使用されます。

> [!NOTE]
> Azure AI Language の質問応答機能は QnA Maker サービス (個別のサービスとして供されているが、近い将来廃止される予定) の新しいバージョンです。

## このコースのリポジトリを Azure Cloud Shell に複製する

Cloud Shell を操作するには、新しいブラウザー タブを開きます。 このリポジトリを最近 Cloud Shell に複製していない場合は、次の手順に従って最新のバージョンがあることを確認します。 それ以外の場合は、Cloud Shell を開き、複製に移動します。

1. [Azure portal](https://portal.azure.com?azure-portal=true) で、ページ上部の検索ボックスの右側にある **[>_]** (*Cloud Shell*) ボタンを選びます。 ポータルの下部に Cloud Shell ペインが開きます。

    ![上部の検索ボックスの右側にあるアイコンをクリックして Cloud Shell を開始している状態のスクリーンショット。](images/cloudshell-launch-portal.png#lightbox)

2. Cloud Shell を初めて開くと、使用するシェルの種類 (*Bash* または *PowerShell*) を選択するように求められる場合があります。 **[Bash]** を選択します。 このオプションが表示されない場合は、この手順をスキップします。  

3. Cloud Shell のストレージを作成するように求めるメッセージが表示された場合は、お使いのサブスクリプションが指定されていることを確認して、**[ストレージの作成]** を選択します。 その後、ストレージが作成されるのを 1 分程度待ちます。

4. Cloud Shell ペインの左上に表示されるシェルの種類が *Bash* に切り替えられたことを確認します。 *PowerShell* の場合は、ドロップダウン メニューを使用して *Bash* に切り替えます。

5. ターミナルが起動したら、次のコマンドを実行して、リポジトリのコピーを Cloud Shell にダウンロードします。

    ```bash
    rm -r azure-ai-eng -f
   git clone https://github.com/MicrosoftLearning/AI-102-AIEngineer azure-ai-eng
    ```

6. ファイルは **azure-ai-eng** というフォルダーにダウンロードされています。 次を実行して、そのフォルダーに移動します。

    ```bash
    cd azure-ai-eng/12-qna
    ```

## Azure AI Language リソースの作成

質問に答えるナレッジ ベースを作成してホストするには、Azure サブスクリプションに **Azure AI Language** リソースが必要です。

1. Azure portal (`https://portal.azure.com`) を開き、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
1. 上部の検索フィールドに「**Azure AI サービス**」と入力し、**Enter** キーを押します。
1. 結果の**言語サービス** リソースの下で **[作成]** を選択します。
1. **カスタム質問応答** ブロックを**選択**します。 **[リソースの作成を続行する]** を選びます。 次の設定を入力する必要があります。

    - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
    - **リソース グループ**: *リソース グループを選択または作成します (制限付きサブスクリプションを使用している場合は、新しいリソース グループを作成する権限がないことがあります。提供されているものを使ってください)*
    - **[リージョン]** : *利用可能な場所を選択する*
    - **[名前]**: *一意の名前を入力します*
    - **[価格レベル]**: Standard
    - **Azure Search のリージョン**: *言語リソースと同じグローバル リージョン内の場所を選択します*。
    - **Azure Search の価格レベル**：無料 (F) ("*このレベルが利用できない場合は、[基本 (B)] を選択してください*")
    - **責任ある AI 通知**: "同意"

1. [**作成と確認**] を選択し、次に [**作成**] を選択します。
    > [!NOTE]
    > カスタム質問応答は、Azure Search を使用して、質問と回答のナレッジ ベースにインデックスを付けてクエリを実行します。

1. デプロイが完了するまで待ち、デプロイの詳細を表示します。

## 質問応答プロジェクトを作成する

Azure AI Language リソースで質問応答のナレッジ ベースを作成するには、Language Studio ポータルを使用して質問応答プロジェクトを作成します。 この場合、[Microsoft Learn](https://docs.microsoft.com/learn) に関する質問と答えを含むナレッジ ベースを作成します。

1. 新しいブラウザー タブで [Language Studio ポータル](https://language.cognitive.azure.com/)に移動し、Azure サブスクリプションに関連付けられている Microsoft アカウントを使ってサインインします。
1. 言語リソースの選択を求めるメッセージが表示されたら、次の設定を選択します。
    - **Azure ディレクトリ**: ご利用のサブスクリプションを含む Azure ディレクトリ
    - **Azure サブスクリプション**: ご利用の Azure サブスクリプション
    - **言語リソース**: 以前に作成した Azure AI Language リソース。
1. **完了**を選択します。
1. 言語リソースの選択を求めるメッセージが表示<u>されない</u>場合、原因として、お使いのサブスクリプションに複数の言語リソースが存在していることが考えられます。その場合は、次の操作を行います。
    1. ページの上部にあるバーで、[**設定**] (⚙) ボタンを選択します。
    2. **[設定]** ページで、**[リソース]** タブを表示します。
    3. 作成したばかりの言語リソースを選択し、**[リソースの切り替え]** をクリックします。
    4. ページの上部で、**[Language Studio]** をクリックして、Language Studio のホーム ページに戻ります。
1. ポータルの上部にある **[Create new]** メニューで、 **[Custom question answering]** (カスタム質問と回答) を選択します。
1. ***プロジェクトの作成**ウィザードの**言語設定の選択**ページで、[**このリソースのすべてのプロジェクトの言語を設定する**] オプションを選択し、言語として**英語**を選択します。 **[次へ]** を選択します。
1. **基本情報の入力**ページで、次の詳細を入力します。
    - **名前** LearnFAQ
    - **[説明]** : Microsoft Learn のよくあるご質問
    - **回答が返されない場合の既定の回答**: 申し訳ございません。質問がよくわかりませんでした
1. **[次へ]** を選択します。
1. **確認と完了**ページで、**[プロジェクトの作成]** を選択します。

## ナレッジ ベースにソースを追加する

ナレッジ ベースは最初から作成できますが、既存の FAQ ページまたはドキュメントから質問と回答をインポートすることから始めるのが一般的です。 この場合、Microsoft Learn の既存の FAQ Web ページからデータをインポートし、一般的な会話のやり取りをサポートするために、あらかじめ定義された "おしゃべり" の質問と回答もインポートします。

1. 質問応答プロジェクトの **[ソースの管理]** ページにある **[&#9547; ソースの追加]** の一覧で、 **[URL]** を選択します。 次に、**[URL の追加]** ダイアログ ボックスで [**[╋ URL の追加]** を選択し、次の名前と URL を設定してから、**[すべて追加]** を選択してナレッジ ベースに追加します。
    - **名前**: `Learn FAQ Page`
    - **URL**: `https://docs.microsoft.com/en-us/learn/support/faq`
1. 質問応答プロジェクトの **[ソースの管理]** ページで、 **[&#9547; ソースの追加]** の一覧にある **[Chitchat](おしゃべり)** を選択します。 次に、**[おしゃべりの追加]** ダイアログ ボックスで、**[フレンドリ]** を選択し、**[おしゃべりの追加]** をクリックします。

## ナレッジ ベースを編集する

ナレッジ ベースには、Microsoft Learn FAQ の質問と回答のペアが入力されており、会話型 *chit-chat* の質問と回答のペアが追加されています。 質問と回答のペアを追加することで、ナレッジ ベースを拡張できます。

1. Language Studio の **[LearnFAQ]** プロジェクトで、**ナレッジ ベースの編集**ページを選択して既存の質問と回答のペアを表示します (複数のヒントが表示されている場合は、それを読み、**[了解]** を選択して閉じるか、**[すべてスキップ]** をクリックします)。
1. ナレッジ ベースの [**質問と回答のペア**] タブで、「**＋**」を選択し、次の設定で新しい質問と回答のペアを作成します。
    - **ソース**: `https://docs.microsoft.com/en-us/learn/support/faq`
    - **質問**: `What is Microsoft certification?`
    - **回答**: `The Microsoft Certified Professional program enables you to validate and prove your skills with Microsoft technologies.`
1. **完了**を選択します。
1. 作成された「**Microsoft 認定資格とは?** 」という質問のページで、 **[代わりの質問]** を展開します。 次に、代わりの質問 `How can I demonstrate my Microsoft technology skills?` を追加します。

    場合によっては、ユーザーが回答をフォローアップして、*マルチターン*会話を作成できるようにすることが理にかなっています。ユーザーは、質問を繰り返し絞り込んで、必要な回答にたどり着きます。

1. 認定資格についての質問に対して入力した答えで [**フォローアップ プロンプト**] を展開し、次のフォローアップ プロンプトを追加します。
    - **ユーザーへのプロンプトに表示されるテキスト**: `Learn more about certification`。
    - [**新しいペアへのリンクの作成**] を選択し、「`You can learn more about certification on the [Microsoft certification page](https://docs.microsoft.com/learn/certifications/).`」のテキストを入力します。
    - **[コンテキスト フローでのみ表示]** を選択します。 このオプションにより、元の認定質問からのフォローアップ質問のコンテキストでのみ回答が返されるようになります。
1. [**プロンプトの追加**] を選択します。

## ナレッジ ベースのトレーニングとテスト

ナレッジベースができたので、Language Studio でテストできます。

1. 左側の **[質問応答ペア]** タブの下にある **[保存]** ボタンを選択して、ナレッジ ベースへの変更を保存します。
1. 変更が保存されたら、[**テスト**] を選択して、テスト ウィンドウを開きます。
1. テスト ウィンドウの上部にある **[短い回答の応答を含める]** の選択を解除します (まだ選択されていない場合)。 次に、下部に「`Hello`」というメッセージを入力します。 適切な応答が返される必要があります。
1. テスト ペインの下部に「`What is Microsoft Learn?`」というメッセージを入力します。 FAQ から適切な応答が返されるはずです。
1. 「`Thanks!`」というメッセージを入力します。適切なおしゃべりの応答が返されます。
1. 「`Tell me about Microsoft certification`」というメッセージを入力します。 作成した回答が、フォローアップ プロンプト ボタンとともに返されます。
1. **[Learn more about certification]** ボタンを選択します。 認定ページへのリンクを含むフォローアップ回答を返送する必要があります。
1. ナレッジ ベースのテストが完了したら、テスト ペインを閉じます。

## ナレッジ ベースのデプロイとテスト

ナレッジ ベースは、クライアント アプリケーションが質問に回答するために使用できるバックエンド サービスを提供します。 これで、ナレッジ ベースを公開し、クライアントからその REST インターフェイスにアクセスする準備が整いました。

1. Language Studio で、**LearnFAQ** プロジェクトの **[ナレッジ ベースのデプロイ]** ページを選択します。
1. ページの上部で、**[デプロイ]** を選択します。 次に、**[デプロイ]** をクリックして、ナレッジ ベースをデプロイすることを確認します。
1. デプロイが完了したら、**[予測 URL の取得]** をクリックしてナレッジ ベースの REST エンドポイントを表示し、それをクリップボードにコピーします (ただし、ダイアログ ボックスはまだ閉じないでください)。
1. Azure Cloud Shell の **12-qna** フォルダーで、`code ask-question.sh` を実行して **ask-question.sh** を開きます。 このスクリプトでは、*Curl* を使用して、質問応答エンドポイントの REST インターフェイスを呼び出します。
1. スクリプトで、***YOUR_PREDICTION_ENDPOINT*** をコピーした予測エンドポイントに置き換えます (必ず引用符で囲んでください)。 **Ctrl + S キー**を選択して、変更を保存します。
1. ブラウザーに戻り、 **[予測 URL の取得]** ダイアログ ボックスで、サンプルの要求に **Ocp-Apim-Subscription-Key** パラメーターの値が含まれていることを確認します。これは、*ab12c345de678fg9hijk01lmno2pqrs34* のようになります。 これはリソースの承認キーです。 それをクリップボードにコピーしたら、**[閉じる]** をクリックして、ダイアログ ボックスを閉じます。
1. Cloud Shell に戻り、**ask-question.sh** スクリプトの *YOUR_KEY* をコピーしたキーに置き換えます (必ず引用符で囲んでください)。 **Ctrl + S キー**を選択して、変更を保存します。
1. スクリプトの Curl コマンドによって、**What is a Learning Path?** (ラーニング パスとは何ですか) という値を持つ **question** パラメーターが送信されることに注意してください。
1. スクリプト全体が次のコードのようになっていることを確認し、ファイルを保存します。

    ```bash
    prediction_url="https://my-example-resource.cognitiveservices.azure.com/language/:query-knowledgebases?projectName=LearnFAQ&api-version=2021-10-01&deploymentName=production"
    key="123ca1b012ec4e4456dab367fefdf178"
    
    curl -X POST $prediction_url -H "Ocp-Apim-Subscription-Key: $key" -H "Content-Type: application/json" -d "{'question': 'What is a learning Path?' }"
    ```

1. ターミナル ペインで、スクリプトを実行するコマンド `ask-question.sh` を入力し、サービスによって返された JSON 応答を表示します。これには、*What is a learning path?* という質問に対する適切な回答が含まれているはずです。

## ナレッジ ベース用のボットを作成する

最も一般的には、ナレッジ ベースから回答を取得するために使用されるクライアント アプリケーションはボットです。

1. ブラウザーで Language Studio に戻り、 **[ナレッジ ベースのデプロイ]** ページで **[ボットの作成]** を選択します。 これにより、Azure portal が新しいブラウザー タブで開き、Azure サブスクリプションでボットを作成できます (メッセージが表示されたら、サインインします)。
1. Azure portal で、次の設定でボットを作成します (ほとんどの設定は事前入力されています)。

    *一部の値が欠落している場合は、ブラウザーを更新します。*  

    - **[ボット ハンドル]**: *ボットの一意の名前*
    - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
    - **[リソース グループ]** : *言語リソースを含むリソース グループ*
    - **価格レベル**: Standard。
    - **作成の種類**: 新しいユーザー割り当てマネージド ID を作成します。

1. **[次へ]** を選択し、自動的に設定されていない場合は次の設定を行います。

    - **アプリ名**: ***ボット ハンドル**と同じで、一意の ID と *.azurewebsites.net* が自動的に追加されます。*
    - **[SDK 言語]**: *C# または Node.js を選択します*
    - **作成の種類**: これは、適切なプランと場所が存在する場合は、自動的に設定されることがあります。 そうでない場合は、**新しい App Service プランの作成***を選択します。
    - **言語リソース キー**: *以前にコピーしたキー*。
1. **[Review + create](レビュー + 作成)** を選択します。 **[作成]** を選択します。

1. ボットが作成されるまで待ちます。 次に、**[リソース グループに移動]** を選択します (または、ホーム ページで **[リソース グループ]** を選択します)。
1. ボットを開くには、リソースの一覧で Azure Bot リソースを選択します。
1. ボットの概要ウィンドウで、**Web チャットでのテスト**ページを表示し、ボットが「**こんにちは、ようこそ!**」というメッセージを表示するまで待ちます。 (初期化には数秒かかることがあります)。
1. テスト チャット インターフェイスを使用して、ボットがナレッジ ベースから期待どおりに質問に回答することを確認します。 たとえば、`What is Microsoft certification?` を送信してみます。

## 詳細情報

Azure AI Language の詳細については、「[Azure AI Language のドキュメント](azure/ai-services/language-service/question-answering/overview)」を参照してください。
